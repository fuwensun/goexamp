# GitOps

- DevOps：版本控制、代码审查、以及CI/CD管道等
- DevOps 软件开发生命周期中的自动化,基础架构的设置和部署时，仍然依赖手动
- GitOps 提供了一套管理基础架构的自动化方法.
- GitOps 使用声明文件，将基础架构编写为代码(infrastructure as code，IaC)，自动化配置的过程。像存储应用程序开发代码那样，将基础架构存储放在Git存储库中.

## GitOps 的工作原理

- 基于容器的应用往往比较复杂，而且难以进行配置和管理
- GitOps 概念由 Kubernetes 管理公司 Weaveworks (请参见https://www.weave.works/)提出的
- GitOps 目标在 Kubernetes 背景下,采用 DevOps 领域的成熟技术,将编排平台转换到运行在容器中的微服务上

下面深入 GitOps 主要组成部分：

## 基础架构即代码(IaC)

- IaC 通过将各种声明式文件以代码的方式存储，实现基础架构的配置和管理
- 通过 IaC 和 版本控制，优化各项操作进程
- 声明式 (Declarative)，意味配置不再是一组命令，而是对某种预期状态的声明
  - 例如：在 Kubernetes 清单文件 (manifest) 中定义服务的 Pod 数量。系统自动获取容器数量，无需人工编写命令脚本。
- 符合声明式模型的云原生软件，都可以视为代码。将各种所需的状态声明为代码，系统应用自动实现目标状态。
  - 例如：使用 AWS CloudFormation 声明性工具，来编写 AWS 的基础架构。

## 拉取请求(Pull Requests)

- GitOps 概念主要思想是：版本控制系统是唯一的来源
  - 将 Git 作为应用代码的变更管理系统，通过拉取请求，操作变更
  - 将 Git 用于基础架构的代码，将声明文件集中于一处

- 应用开发的工作流
  - 需要将某个主分支作为发布分支
  - 从主分支创建功能分支，发出特定的功能或故事线
  - 在功能性分支上，一旦完成了更改，通过创建拉取请求，合并回主分支
  - 这样方便实现协作的同时，透明地获悉到谁在何处进行何种更改
  - 更改都是在 Git 处被提交的，进行问题的跟踪，非常实用的

- 创建拉取请求的好处
  - 代码在被集成到另一个分支之前，进行代码的审查
  - 代码审查能够阻止各种不良的代码，进入测试或生产环境
  - 对于故障的消除，以及基础架构代码，都是非常重要的

## Git的组成

- 部署 GitOps 时需要两个存储库
  - 应用代码库：存储应用源代码、及其部署(环境)清单`代码和目标环境声明`
  - 环境配置库：存储整个系统(基础设施)的期望状态，由各个环境的申明清单构成`声明基础设施的状态即环境`

- 在代码库中可以声明环境为 dev、test、production，这样就包含了应用程序和能运特定版本那个环境的基础设施服务
`应用+特定环境的基础设施服务`
- 对于基础设施，主分支可以表示一个环境。可以在特性分支中更改。再创建请求来合并更改到主分支。这样，就可以进行协作，同时清楚的知道谁执行了哪些更改。这也有利于跟踪问题的根本原因，因为所有更改都是在 Git 中提交的

- GitOps 不依赖于任何工具或技术。可以与 GitHub、BitBucket 或 GitLab 等，基于 Git 的系统协同使用

## CI/CD

- 完整的 GitOps 实现，需要 CI/CD 管道
- 当 Git 仓库发生改变时，通过自动部署管道，可以把基础设施的改变部署到设计环境
- 管道连接着 Git 的 pull request 到编排系统。当 pull request 触发部署管道时，编排系统就执行任务
- 有两种 GitOps 部署策略：推和拉管道。他们的不同点在于确认部署环境的基础设是期望的

Push Pipelines

- 许多流行的 CI/CD 工具使用这种策略
- 建议把源码和部署清单存在一个库中。当新的变更发生在库中时，构建管道被触发。管道构建容器镜像并推送变更到环境
- 这种策略有其他的好处，比如能支持任何类型的基础设施。缺点是给予 CI/CD 工具写入环境的权限

## Pull Pipelines

- 社区认为 pull pipeline 方式是更加安全的 GitOps 实践。这种方式，需要 operator
- operator 是连接 pipeline 和编排工具的组件
- operator 持续的比较环境库中的目标状态和部署的基础设置中的真实状态。检测到状态变化，就改变基础设施的状态去匹配环境库。
- operator 监视映像注册表来确定要部署的映像的新版本。这就是 GitOps 特别的地方

在 GitOps 中

- 只有当环境库中的内容变化时环境才会被更新
- 系统会重置修改，如果已经实现的基础设施的改变不是环境库定义的

大多数的应用，需要多个环境

- GitOps 允许创建多个管道去改变环境，可以使用环境库中的单个分支去管理多个环境(一对多)
- operator 可以通过部署到生产环境来响应一个分支的更改，也可以通过部署到测试来响应另一个分支(一对一)。

>https://dzone.com/articles/gitops-devops-for-infrastructure-automation
