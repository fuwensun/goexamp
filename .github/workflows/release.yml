name: release

on:
  push:
    branches: release*
    tags: v*
  pull_request:
    branches: release*
    tags: v*

env:
  RHUB: ${{ 'docker.pkg.github.com' }}
  RHUB_USERNAME: ${{ github.repository_owner }}
  RHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  RSPACE: ${{ github.repository }}

jobs:

  env:
    name: env
    runs-on: ubuntu-latest
    steps:
    - name: Check out code
      uses: actions/checkout@v2

    - name: Print env
      run: |
        whoami
        pwd
        which go
        which docker
        groups $(whoami)
        ls -a -l ./
        go env GOPROXY
        docker images
        git log -1 --oneline

        echo "==> github.repository_owner: ${{ github.repository_owner }}"
        echo "==> github.repository: ${{ github.repository }}"
        echo "==> github.ref: ${{ github.ref }}"

        echo "==> ${{ contains(github.ref, 'refs/heads/release') }}"
        echo "==> ${{ contains(github.ref, 'refs/tags/v') }}"

  run:
    name: run
    runs-on: ubuntu-latest

    steps:
    - name: Check out code
      uses: actions/checkout@v2

    - name: Build
      working-directory: ./build
      run: |
        chmod +x ./build.sh && ./build.sh

    - name: Release
      if: contains(github.ref, 'refs/tags/v')
      working-directory: ./eApi/build
      run: |
        echo "${RHUB_TOKEN}" | docker login ${RHUB} -u ${RHUB_USERNAME} --password-stdin
        make release
